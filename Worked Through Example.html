<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shelby Golden">
<meta name="dcterms.date" content="2025-03-27">

<title>Data Visualization with ggplot2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Worked Through Example_files/libs/clipboard/clipboard.min.js"></script>
<script src="Worked Through Example_files/libs/quarto-html/quarto.js"></script>
<script src="Worked Through Example_files/libs/quarto-html/popper.min.js"></script>
<script src="Worked Through Example_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Worked Through Example_files/libs/quarto-html/anchor.min.js"></script>
<link href="Worked Through Example_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Worked Through Example_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Worked Through Example_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Worked Through Example_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Worked Through Example_files/libs/bootstrap/bootstrap-973236bd072d72a04ee9cd82dcc9cb29.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(Images/Workshop_Materials_Header_Background.png);
background-size: cover;
      }
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Data Visualization with ggplot2</h1>
            <p class="subtitle lead">Worked Through Example</p>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliations</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><a href="https://outlook.office365.com/owa/calendar/DataScienceDataEquityOfficeHours@yale.edu/bookings/">Shelby Golden, M.S.</a> <a href="mailto:shelby.golden@yale.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Yale School of Public Health Data Science and Data Equity (DSDE)
            </p>
          <p class="affiliation">
              
            </p>
          <p class="affiliation">
              <a href="ysph.yale.edu/dsde">
              
              </a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 27, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#set-up-the-environment" id="toc-set-up-the-environment" class="nav-link" data-scroll-target="#set-up-the-environment">Set Up the Environment</a></li>
  <li><a href="#basic-uses-of-ggplot2" id="toc-basic-uses-of-ggplot2" class="nav-link" data-scroll-target="#basic-uses-of-ggplot2">Basic Uses of <code>ggplot2()</code></a>
  <ul class="collapse">
  <li><a href="#the-data-and-mapping-layers" id="toc-the-data-and-mapping-layers" class="nav-link" data-scroll-target="#the-data-and-mapping-layers">The <strong>Data</strong> and <strong>Mapping</strong> Layers</a></li>
  <li><a href="#the-geometry-layer" id="toc-the-geometry-layer" class="nav-link" data-scroll-target="#the-geometry-layer">The <strong>Geometry</strong> Layer</a></li>
  <li><a href="#the-statistics-layer" id="toc-the-statistics-layer" class="nav-link" data-scroll-target="#the-statistics-layer">The <strong>Statistics</strong> Layer</a></li>
  <li><a href="#the-scales-layer" id="toc-the-scales-layer" class="nav-link" data-scroll-target="#the-scales-layer">The <strong>Scales</strong> Layer</a></li>
  <li><a href="#the-facets-layer" id="toc-the-facets-layer" class="nav-link" data-scroll-target="#the-facets-layer">The <strong>Facets</strong> Layer</a></li>
  <li><a href="#the-coordinates-layer" id="toc-the-coordinates-layer" class="nav-link" data-scroll-target="#the-coordinates-layer">The <strong>Coordinates</strong> Layer</a></li>
  <li><a href="#the-theme-layer" id="toc-the-theme-layer" class="nav-link" data-scroll-target="#the-theme-layer">The <strong>Theme</strong> Layer</a></li>
  <li><a href="#overlaying-layers" id="toc-overlaying-layers" class="nav-link" data-scroll-target="#overlaying-layers">Overlaying Layers</a></li>
  </ul></li>
  <li><a href="#advanced-uses-of-ggplot2" id="toc-advanced-uses-of-ggplot2" class="nav-link" data-scroll-target="#advanced-uses-of-ggplot2">Advanced Uses of <code>ggplot2()</code></a>
  <ul class="collapse">
  <li><a href="#introduction-to-map-projections-with-ggoplot" id="toc-introduction-to-map-projections-with-ggoplot" class="nav-link" data-scroll-target="#introduction-to-map-projections-with-ggoplot">Introduction to Map Projections with <code>ggoplot</code></a></li>
  <li><a href="#introduction-to-interactive-plotting-with-plotly" id="toc-introduction-to-interactive-plotting-with-plotly" class="nav-link" data-scroll-target="#introduction-to-interactive-plotting-with-plotly">Introduction to Interactive Plotting with <code>plotly</code></a></li>
  </ul></li>
  <li><a href="#challenge-questions" id="toc-challenge-questions" class="nav-link" data-scroll-target="#challenge-questions">Challenge Questions</a></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a></li>
  </ul>
</nav>
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this workshop we delve deeper into the domain specific language of statistical graphics that underpins the <code>tidyverse</code> <code>ggplot2</code> package syntax: the “Grammar of Graphics”. We will explore each discrete grammar layer using laboratory-confirmed RSV hospitalizations data collected by the CDC’s Respiratory Virus Hospitalization Surveillance Network (RESP-NET) surveillance program.</p>
<p>With a better understanding of the syntax fundamentals, we will then get introduced to some advanced uses of <code>ggplot2</code> that are commonly used in public health:</p>
<ul>
<li>Making plots interactive with <code>plotly</code></li>
<li>Projecting data to a map</li>
</ul>
<p>We will close the workshop by asking <a href="https://ai.yale.edu/yales-ai-tools-and-resources/clarity-platform">Yale’s Clarity Platform</a> to reproduce our code from the plot image alone to exhibit how AI can be used to support data visualization work. Clarity is an AI chatbot that offers similar functions to OpenAI’s ChatGPT and Microsoft Copilot with additional data protection. Find out more about <a href="https://ai.yale.edu/yales-ai-tools-and-resources/clarity-platform/clarity-platform-security?check_logged_in=1">Clarity’s security</a> guidelines on “AI at Yale”.</p>
<p>The cleaned and harmonized version of the RSV-NET dataset was compiled as part of the YSPH’s very own PopHIVE project. Special thanks to <a href="https://ysph.yale.edu/profile/daniel-weinberger/">Professor Daniel Weinberger</a> for allow us to use his own plots in this workshop.</p>
</section>
<section id="set-up-the-environment" class="level2">
<h2 class="anchored" data-anchor-id="set-up-the-environment">Set Up the Environment</h2>
<p>First, we will load the necessary libraries and any special functions used in the script.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: renv initializing might need to be run twice after the repo is</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#       first copied.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">restore</span>()</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"arrow"</span>)         <span class="co"># For reading in the data</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"dplyr"</span>)         <span class="co"># For data manipulation</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"ggplot2"</span>)       <span class="co"># For creating static visualizations</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"plotly"</span>)        <span class="co"># For interactive plots</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"cowplot"</span>)       <span class="co"># ggplot add on for composing figures</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"RColorBrewer"</span>)  <span class="co"># Load Color Brewer color palettes</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to select "Not In"</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="st">'%!in%'</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x,y)<span class="sc">!</span>(<span class="st">'%in%'</span>(x,y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we will import our cleaned and tidy data, which is ready for plotting. Students who would like to find out more about how to get their data into the plottable, tabular form you will see here can explore our <a href="https://github.com/ysph-dsde/A-Journey-Into-The-World-of-tidyverse-Workshop">A Journey into the World of tidyverse</a> workshop.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Code Like a Pro">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Code Like a Pro
</div>
</div>
<div class="callout-body-container callout-body">
<p>Our data was stored as a parquet file. Para-what? Parquet is a column-oriented data file that allows for efficient data storage and lightweight information retrieval. It is best suited for large data sets that cannot be easily handled “in-memory”. Using the <code>arrow</code> package, we can read and manipulate files in this form.</p>
<p>Those interested to learn more about how they can use parquet to efficiently process large datasets are encouraged to review the workshops hosted by one of our guest speakers, Professor Thomas Lumley: <a href="https://github.com/ysph-dsde/Thomas-Lumley-Workshops/">Thomas Lumley Workshops</a>.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(<span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"RSV-NET Infections.gz.parquet"</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse() allows us to see the dimensions of the dataset, column names,</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the first few entries, and the vector class in one view.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 92,519
Columns: 14
$ Region                  &lt;chr&gt; "California", "California", "California", "Cal…
$ Season                  &lt;chr&gt; "2018-19", "2018-19", "2018-19", "2018-19", "2…
$ `Week Observed`         &lt;date&gt; 2018-10-06, 2018-10-13, 2018-10-20, 2018-10-2…
$ MMWRyear                &lt;dbl&gt; 2018, 2018, 2018, 2018, 2018, 2018, 2018, 2018…
$ MMWRweek                &lt;dbl&gt; 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25…
$ MMWRday                 &lt;dbl&gt; 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7…
$ Characteristic          &lt;chr&gt; "Age", "Age", "Age", "Age", "Age", "Age", "Age…
$ Level                   &lt;chr&gt; "1-4 Years", "1-4 Years", "1-4 Years", "1-4 Ye…
$ `Positives Detected`    &lt;dbl&gt; 0, 0, 3, 10, 8, 8, 3, 6, 8, 15, 15, 25, 23, 22…
$ `Scaled Positives`      &lt;dbl&gt; 0.000000, 0.000000, 3.896104, 12.987013, 10.38…
$ Spline                  &lt;dbl&gt; 0.000000, 2.184079, 5.738394, 8.770741, 9.5923…
$ Kernel                  &lt;dbl&gt; 0.000000, 2.897880, 6.721988, 9.740228, 10.945…
$ `Crude Rate`            &lt;dbl&gt; 0.0, 0.0, 0.6, 2.5, 1.9, 1.9, 0.6, 1.3, 1.9, 3…
$ `Cumulative Crude Rate` &lt;dbl&gt; 0.0, 0.0, 0.6, 3.1, 5.0, 6.9, 7.6, 8.8, 10.7, …</code></pre>
</div>
</div>
<p><strong>ADD quick description of the data</strong></p>
<p>season (July to June of the following year)</p>
</section>
<section id="basic-uses-of-ggplot2" class="level2">
<h2 class="anchored" data-anchor-id="basic-uses-of-ggplot2">Basic Uses of <code>ggplot2()</code></h2>
<div>
    <div style="float: left; position: relative; top: 0px; padding: 30px;">
    <a href="https://www.youtube.com/watch?v=h29g21z0a68">
      <img src="images/All Layers.png" alt="Layers of the Grammar of Graphics" width="350px" height="auto">
    </a>
    <figcaption>Figure from "ggplot2 workshop part 1" by Thomas <br>Lin Pedersen. Accessed from YouTube March <br> 15th, 2025.</figcaption>
    </div>
</div>
<section id="the-data-and-mapping-layers" class="level3">
<h3 class="anchored" data-anchor-id="the-data-and-mapping-layers">The <strong>Data</strong> and <strong>Mapping</strong> Layers</h3>
<p>The first (and arguably most crucial!) layer is <strong>Data</strong>, but simply adding it to <code>ggplot()</code> will only generate a plot object with nothing else. In the second layer, <strong>Mapping</strong>, we tell the function which variables get used for which aesthetic feature displayable on the plot object.</p>
<p>In this layer, we define the position, color, size, or shape that our values take. Every type of data representation requires an aesthetic statement to point variables to relevant aesthetic features. This can help make a plot visually appealing, but an astute user of <code>ggplot()</code> will leverage them to highlight underlying patterns in the data as well.</p>
<p>Here we use the mapping function, <code>aes()</code>, to point the week in the epidemiological year (MMWR) variable to the <span class="math inline">\(x\)</span>-axis and RSV positive tests (scaled and Gaussian kernel smoothed) to the <span class="math inline">\(y\)</span>-axis.</p>
<div class="callout callout-style-default callout-important callout-titled" title="Geometry and Statistic Layers Dictate the Aesthetics Mapping">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Geometry and Statistic Layers Dictate the Aesthetics Mapping
</div>
</div>
<div class="callout-body-container callout-body">
<p>As we will see in the next two layers, the kinds of features that are required to generate the most fundamental visualization of our data will depend on the type of geometry or statistical transformation we are plotting. <strong>Data</strong> and <strong>Mapping</strong> must always be defined by the user. Some <code>geom_*()</code> or <code>stat_*()</code> functions also require the plot-specific statistic or position to be provided by the user, but sometimes these elements are already assigned by the default settings.</p>
<p>You can find more about the required and ancillary aesthetic features used by different <strong>Geometry</strong> or <strong>Statistics</strong> layers in the <code>ggplot2</code> <a href="https://ggplot2.tidyverse.org/reference/index.html">package references</a> documentation and <a href="https://github.com/rstudio/cheatsheets/blob/main/data-visualization.pdf">cheatsheet</a>. Different specifications available for aesthetic features can also be found in one of their vignettes: <a href="https://ggplot2.tidyverse.org/articles/ggplot2-specs.html">aesthetic specifications</a>.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The data and aesthetics mapping layers combined.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Worked-Through-Example_files/figure-html/layers_1_2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can use the base R pipe symbol <code>|&gt;</code> to pass objects into subsequent functions that build on the previous result. This has the added benefit of organizing operations into digestible pieces, as opposed to gnarly nested functions. That would not be so knarly, man!</p>
<p>Going forward we will no longer explicitly dictate that <code>data = df</code>, as this is already implied by the pipe operation. Just keep in mind that the start of a graphical expression begins with a <code>ggplot() +</code> statement, and everything preceding this is not part of the graphical layers.</p>
</div>
</div>
</section>
<section id="the-geometry-layer" class="level3">
<h3 class="anchored" data-anchor-id="the-geometry-layer">The <strong>Geometry</strong> Layer</h3>
<p>We will now tell the function how we want the data to be displayed in the plot object. We do this by adding the <strong>Geometry</strong> layer. Together with <strong>Data</strong> and <strong>Mapping</strong>, these three layers form the core pieces required to generate any basic visualization with <code>ggplot2</code>.</p>
<p>The <strong>Geometry</strong> layer does the computational legwork that translate a data frame with mappings into a discernible plot. Behind the scenes, it is computing how points get spaced and oriented to create the specific geometry defined, whether that be for a histogram, scatter plot, box plot, and so forth.</p>
<p>Each geometry layer can take a specific data and aesthetics mapping, overwriting anything defined in the <code>ggplot()</code> plot object. It also interprets a statistical transformation and position adjustment to modulate the graph. Here, we will plot a trend line showing changes in RSV positives detected over the course of an infection season by using <code>geom_line()</code>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In some <code>ggplot2</code> references statistics and position are both defined as separate layers in the hierarchy. This workshop separates out statistics, but does not separate out position its own layer.</p>
<p>Position sets the rules around how objects get placed relative to one another; a setting necessary within some <code>geom_*</code> functions. Think of plotting a histogram scaled with an aesthetic color mapping. Do the groupings plot on top of each other, side-by-side, or get scaled to fill [0, 1] on the <span class="math inline">\(y\)</span>-axis? This is what the position setting will determine.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All three required layers combined: data, aesthetics mapping, and geometry.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Worked-Through-Example_files/figure-html/layers_basic_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Look at this plot, I mean oy vey! If we think back to the glimpse of our dataset we might remember that there are additional columns of information that we can use to further distinguish one infections trend.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$Region
 [1] "California"     "Colorado"       "Connecticut"    "Georgia"       
 [5] "Maryland"       "Michigan"       "Minnesota"      "New Mexico"    
 [9] "New York"       "North Carolina" "Oregon"         "Region 1"      
[13] "Region 10"      "Region 2"       "Region 3"       "Region 4"      
[17] "Region 5"       "Region 6"       "Region 8"       "Region 9"      
[21] "Tennessee"      "Utah"          

$Season
[1] "2016-17" "2017-18" "2018-19" "2019-20" "2020-21" "2021-22" "2022-23"
[8] "2023-24" "2024-25"

$`Characteristic Level`
 [1] "1-4 Years"                        "18-49 Years"                     
 [3] "5-17 Years"                       "50-64 Years"                     
 [5] "65-74 Years"                      "75+ Years"                       
 [7] "&lt;1 Years"                         "American Indian or Alaska Native"
 [9] "Asian or Pacific Islander"        "Black or African American"       
[11] "Female"                           "Hispanic or Latino"              
[13] "Male"                             "N/A"                             
[15] "White"                           </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset the data to one infection trend outcome by selecting one possible</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># instantiation from the array of distringuishing varaibles.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">==</span> <span class="st">"2021-22"</span>, Level <span class="sc">==</span> <span class="st">"N/A"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Worked-Through-Example_files/figure-html/layers_basic_plot_2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This looks much nicer, but it doesn’t tell us much about our data. Notice, however, that the same plot can be generated by adding the aesthetics mapping to the plot object (<code>ggplot()</code>) or the <code>geom_*()</code> layer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A viable alternative representation of the above code:</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">==</span> <span class="st">"2021-22"</span>, Level <span class="sc">==</span> <span class="st">"N/A"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel)) <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Discussion:</strong> Can you think reasons why you would choose one over the other?</p>
<p>You might be asking yourself why I went through the pains of showing the thought process behind tuning the plot so that it shows one distinguishable trend line. Am I not simply covering the grammar of whatever to plot a simple trend line while you eat a delicious cookie and compartmentalize your upcoming exams?</p>
<p>As I hinted at earlier, the advanced user of <code>ggplot2</code> is going to leverage these layers for effective visualization of underlying patterns of the data itself. By controlling for variables that add noise or redundancies to a plot, we are opening the door for inspiring communicating insights through visualization.</p>
<p>Recall:</p>
<blockquote class="blockquote">
<p>“… graphics are instruments of reasoning about quantitative information” – Yale Professor <a href="https://www.edwardtufte.com/online-course/?gad_source=1&amp;gclid=EAIaIQobChMIm-CbxsObjAMV9Fz_AR2jBSK8EAAYASAAEgI6Z_D_BwE">Edward Tufte</a> from his book <em>The Visual Display of Quantitative Information</em></p>
</blockquote>
<p>More on this in a moment. But while I have your attention, those cookies are delicious; this is objectively and observably true.</p>
</section>
<section id="the-statistics-layer" class="level3">
<h3 class="anchored" data-anchor-id="the-statistics-layer">The <strong>Statistics</strong> Layer</h3>
<p>Following the <strong>Geometries</strong> layer in our hierarchy is <strong>Statistics</strong>. In this context, statistics refers to the transformations applied to data primarily for the purposes of generating plottable values. For example, calculating box plot quartiles or bar plot counts.</p>
<p>These same transformations are being used under the hood of the <code>geome_*()</code> functions. As you might expect, many statistics functions are interchangeable with geometric functions. For example, one can use <code>geom_bar(stat = "count")</code> or <code>stat_count(geom = "bar")</code> to produce the same bar plot (<code>ggplot2</code> <a href="https://ggplot2.tidyverse.org/reference/layer_stats.html#paired-geoms-and-stats">Layer statistical transformations - Paired geoms and stats</a>).</p>
<p>Keep in mind, however, that this is not always true, and sometimes statistical functions are sub-components of composite geometric engines. One example being the <code>stat_ydensity()</code> function, which generates the smoothed lines along the <span class="math inline">\(y\)</span>-axis of a violin plot.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you want to use a statistically transformed variable for an aesthetic like fill or color, you need to use <code>after_stat()</code> around the variable name to scale the mapped aesthetic properly. An example provided in the <code>ggplot2</code> cheatsheet is: <code>ggplot(df) + stat_density_2d(aes(fill = after_stat(level)), geom = "polygon")</code>.</p>
</div>
</div>
<p>In our example I had separately smoothed the “Scaled Positives” variable using a spline or Gaussian kernel. If I plot a <code>ggplot2</code> statistic layer that smooths the same variable using the locally estimated scatter plot smoothing (LOESS) method we see it aligns closely with the Gaussian kernel result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">==</span> <span class="st">"2021-22"</span>, Level <span class="sc">==</span> <span class="st">"N/A"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Values smoothed before plotting using Gaussian kernel.</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plotted as the black line.</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel)) <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Values smoothed by the stat_smooth() ggplot function using LOESS.</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plotted as the blue line.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> <span class="st">`</span><span class="at">Scaled Positives</span><span class="st">`</span>),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">geom =</span> <span class="st">"smooth"</span>, <span class="at">method =</span> <span class="st">"loess"</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Worked-Through-Example_files/figure-html/layers_stat-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Code Like a Pro">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Code Like a Pro
</div>
</div>
<div class="callout-body-container callout-body">
<p>When a <code>stat_*()</code> is applied to a data frame (either inside a <strong>Geometric</strong> or <strong>Statistic</strong> layer), a modified data frame is generated as the output containing new, transformed variables. It is possible to call these “generated variables” within the plot object and use them for graph tuning.</p>
<p>One example provided in <em>ggplot2: Elegant Graphics for Data Analysis</em>, shows how to call the <code>stat_density()</code> “generated variable”, density, created when the data frame is passed through <code>geom_histogram()</code>: <a href="https://ggplot2-book.org/layers.html#sec-generated-variables">Chapter 13 Generated variables</a>.</p>
<ul>
<li><code>ggplot(df, aes(x)) + geom_histogram(binwidth = 500)</code> plots a histogram with counts as the <span class="math inline">\(y\)</span>-axis.</li>
<li><code>ggplot(df, aes(x)) + geom_histogram(aes(y = after_stat(density)), binwidth = 500)</code> plots that same histogram with the calculated distribution density as the <span class="math inline">\(y\)</span>-axis.</li>
</ul>
</div>
</div>
</section>
<section id="the-scales-layer" class="level3">
<h3 class="anchored" data-anchor-id="the-scales-layer">The <strong>Scales</strong> Layer</h3>
<p>In the same way the <strong>Statistics</strong> layer defines the statistical transformations happening under the hood of the geometric functions, <strong>Scales</strong> is what interprets an aesthetic <strong>Mapping</strong> into plottable values. Once the aesthetics are defined by the user, the <code>ggplot2</code> algorithm automatically applies the necessary scales. Unless we want to customize the scaling, the user does not need to explicitly write out the default scales needed to generate a plot.</p>
<p>For example, <code>scale_*_continuous()</code> gets automatically applied to our plot because of the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> aesthetics mappings we’ve defined. The code snippet below explicitly writes out these scaling functions that get used, but because we are not modifying their defaults it is not necessary to include them in our own code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The automatically applied scale_*() functions to the x and y mapping.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">==</span> <span class="st">"2021-22"</span>, Level <span class="sc">==</span> <span class="st">"N/A"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel)) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The following two lines are not required for us to include since</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># they are implied by the type of x and y vectors we assigned.</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>() <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One of the greatest advantages to <code>ggplot2</code> is it offers users a great deal of flexibility. This concept is especially true for the <strong>Scales</strong> layer. While the preceding layers offer some level of customization, the <strong>Scales</strong> layer increases the available options by adding on top of previous settings. This cross-layer communication makes for a seemingly endless array of options and can make it one of the hardest layers to master.</p>
<p>Most customization options fall into two buckets:</p>
<ul>
<li>Position scales and axes (<a href="https://ggplot2-book.org/scales-position.html">Chapter 10 of <em>ggplot2: Elegant Graphics for Data Analysis</em></a>)</li>
<li>Color scales and legends (<a href="https://ggplot2-book.org/scales-colour.html">Chapter 11 of the same book</a>)</li>
</ul>
<p>The different applications of <strong>Scales</strong> covered in these chapters range from canonical axes scaling using <code>scale_*_log10()</code>, <code>scale_*_sqrt()</code>, and <code>scale_*_reverse()</code> to tuning axis breaks and labeling or from scaling color pallets to cleaning the legend. The two chapters I’ve cited here from <em>ggplot2: Elegant Graphics for Data Analysis</em> by <a href="https://hadley.nz/">Hadley Wickham</a>, <a href="https://djnavarro.net/">Danielle Navarro</a> and <a href="https://thomaslinpedersen.art/">Thomas Lin Pedersen</a> are invaluable introductions to different applications of <strong>Scales</strong>.</p>
<p>In the <strong>Scales</strong> layer of our example, we will use <code>labs()</code> to customize the plot labels and set the <span class="math inline">\(y\)</span>-axis limits to span the entire range of our variable, <span class="math inline">\([0, 100]\)</span>. It is also possible to assign customized color pallets to grouped outcomes. Say that for our example we want to compare RSV infection trends between seasons going back three years to 2022, including the current infections season. How do we modify our running plot example to do this?</p>
<p>Steps:</p>
<ol type="1">
<li>Add an aesthetic <strong>Mapping</strong> that prompts the plot object to group the unique seasons represented and associate them with a color.</li>
<li>Add a <code>scale_color_*</code> function that will apply a customized color to the <strong>Scales</strong> layer instead of the default palette.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the infection seasons we'd like to see out of the range of options.</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>include_seeasons <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"2022-23"</span>, <span class="st">"2023-24"</span>, <span class="st">"2024-25"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Using Scales to highlight insights to infection trends across seasons.</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>plot_A <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Since we are grouping outcomes by Season, we only need to subset the</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dataset to the three seasons we wish to plot.</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">%in%</span> include_seeasons, Level <span class="sc">==</span> <span class="st">"N/A"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the aesthetic mapping that will color (and group) outcomes based</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># on the unique elements in the Season variable. Also set the y-axis range</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and customize plot labels.</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel, <span class="at">color =</span> Season) ) <span class="sc">+</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"RSV Infection Trends Since 2022"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Weeks Since July"</span>, </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Positive RSV Tests</span><span class="sc">\n</span><span class="st">(scaled and kernel smoothed)"</span>) <span class="sc">+</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Notice that we do not need to specify a scale_color_*() because</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we want this plot to use the default color palette.</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Customizing the color applied to that grouping by building on the first plot.</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>plot_B <span class="ot">&lt;-</span> plot_A <span class="sc">+</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "Type" denotes which set of color palette's to choose from. In</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this case we are choosing from the "Type = Qualitative", from</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># which we can choose the "Palette = Dark2".</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>, <span class="at">palette =</span> <span class="st">"Dark2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Worked-Through-Example_files/figure-html/layers_scales_combine-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Discussion:</strong> We see that associating a variable with an <code>aes(color)</code> will also group by that same variable.</p>
<ul>
<li>What would happen if we only group the outcomes and exclude the color statement: i.e.&nbsp;<code>aes(group = Season)</code>?</li>
<li>Does adding a <code>scale_color_*()</code> statement change the result?</li>
<li>Why do you see the result you get?</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Scales</strong> allows you to modify the limits of axes (i.e.&nbsp;with <code>lims()</code> or <code>*lim()</code>) giving the illusion that you can “zoom” into the plot. This is not a good use of the <strong>Scales</strong> layer, as it will sometimes have the unintended effect of distorting your result. Instead use the <strong>Coordinates</strong> layer to zoom into a select portion of your plot.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Code Like a Pro">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Code Like a Pro
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>ggplot2</code> does not give users a way to combine multiple plots together into one composite figure that is publication-ready. Fortunately, the community developed <code>ggplot2</code> extension, <code>cowplot</code>, was created specifically to support generating publication-quality figures. This is the package extension I used to generate plots <strong>A</strong> and <strong>B</strong> in the recent example!</p>
<p><code>cowplot</code> <a href="https://wilkelab.org/cowplot/">pkgdown page</a> developed by Professor <a href="https://clauswilke.com/">Claus Wilke</a> at the University of Texas at Austin.</p>
</div>
</div>
</section>
<section id="the-facets-layer" class="level3">
<h3 class="anchored" data-anchor-id="the-facets-layer">The <strong>Facets</strong> Layer</h3>
<p>In the recent section, we showed how we can use <strong>Scales</strong> to highlight differences in infection trends between seasons. Doing so will plot the results on the same object, but what if we want to separate group comparisons over multiple plots?</p>
<p>Technically, we could code a new plot for each discrete subgrouping of our data that we want to spread out. If each plot is comprised of the same elements and aesthetic settings, however, there is an easier way to achieve the same result. The <strong>Facets</strong> layer allows us to generate a matrix grid showing the exact same plot for each subgroup available in a discrete variable.</p>
<p>Similar to the <strong>Scales</strong> layer, each plot object we compose implicitly assigns the faceting to <code>NULL</code> by default. The user only needs to include a <strong>Facets</strong> layer expression if they wish to change the default settings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The default faceting is automatically applied.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">%in%</span> include_seeasons, Level <span class="sc">==</span> <span class="st">"N/A"</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel, <span class="at">color =</span> Season) ) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"RSV Infection Trends Since 2022"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Weeks Since July"</span>, </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Positive RSV Tests</span><span class="sc">\n</span><span class="st">(scaled and kernel smoothed)"</span>) <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>, <span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The following line not required for us to include.</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_null</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are two functions for faceting: <code>facet_grid()</code> and <code>facet_wrap()</code>. Both functions receive similar arguments expressed slightly differently, and thus ultimately do the same thing. The biggest difference between them is <code>facet_grid()</code> will divide categories into new columns <em>or</em> rows, while <code>facet_wrap()</code> will optimize the matrix output into a roughly rectangular view.</p>
<p>It is best practice to choose the right faceting function based on how long the array of discrete outcomes you will be showing is. In our case, we are going to further resolve comparisons of RSV infections by seasons to include an additional comparison between a selection of age groups. The dataset includes seven age groups, but we are primarily interested in comparing infection trends in children, adults, and the elderly. We will therefore, only be plotting three different groups, making <code>facet_grid()</code> and acceptable function to use.</p>
<p><code>facet_grid()</code> allows us to specify how the subplots are organized: by new columns <em>or</em> new rows. It is possible to compare as many as two variables by separating one over new columns and another over new rows: <code>facet_grid(rows ~ columns)</code>. We will separate out the age groups over new columns by dictating <code>facet_grid(~Level)</code>. Notice that we want to specify the order we see these panels, which we can do by wrapping our variable name with <code>factor(Level, levels = ordered_vector)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create our ordered vector that will be used in factor().</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ages_ordered <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"5-17 Years"</span>, <span class="st">"18-49 Years"</span>, <span class="st">"75+ Years"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add column-wise faceting.</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We only want to maintain three of the seven age groups recorded. We can</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use the same variable we generate above to select these.</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">%in%</span> include_seeasons, Level <span class="sc">%in%</span> ages_ordered) <span class="sc">|&gt;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel, <span class="at">color =</span> Season) ) <span class="sc">+</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"RSV Infection Trends Since 2022"</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Weeks Since July"</span>, </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Positive RSV Tests</span><span class="sc">\n</span><span class="st">(scaled and kernel smoothed)"</span>) <span class="sc">+</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>, <span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use "~Level" instead of "Level~" to create new plots as columns.</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span><span class="fu">factor</span>(Level, <span class="at">levels =</span> ages_ordered))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Worked-Through-Example_files/figure-html/layers_facets-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-coordinates-layer" class="level3">
<h3 class="anchored" data-anchor-id="the-coordinates-layer">The <strong>Coordinates</strong> Layer</h3>
<p>Up until this point, we have covered layers that attribute variables to geometric-specific aesthetics in <strong>Mappings</strong> and transformations that interpret those assignments into plottable values in <strong>Statistics</strong> and <strong>Scales</strong>. The <strong>Geometry</strong> layer does a combination of statistical transformations and positioning, preparing the attributed variables into values that will take the chart shape we are looking to create.</p>
<p>It is the <strong>Coordinates</strong> layer that then plots these values on a graph. It’s important to appreciate this subtlety because some scaled or statistically transformed values will look entirely different if the wrong coordinate system is applied. Such as, if we attempted to plot an angle on a Cartesian plane in Euclidean space instead of in polar coordinates.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://dark-star-161610.appspot.com/secured/_book/grammar-and-vocabulary.html#coord"><img src="Images/Coordinates_Data%20Visualization%20Bookdown%20Figure%205.5.png" class="img-fluid figure-img" alt="Figure 5.5 from “Data Visualization: From Theory to Practice” by James Baglin. Accessed March 22nd, 2025."></a></p>
<figcaption>Figure 5.5 from “Data Visualization: From Theory to Practice” by James Baglin. Accessed March 22nd, 2025.</figcaption>
</figure>
</div>
<p><strong>Coordinate</strong> layer functions fall into two buckets:</p>
<ul>
<li>Linear: <code>coord_cartesian()</code>, <code>coord_flip()</code>, and <code>coord_fixed()</code></li>
<li>Non-linear: <code>coord_map()</code>/<code>coord_quickmap()</code>/<code>coord_sf()</code>, <code>coord_polar()</code>, and <code>coord_trans()</code></li>
</ul>
<p>Applying the Cartesian, polar, and transformed coordinates is reasonably straightforward, and we will introduce the topic of map projections today. Keep in mind that the <strong>Coordinate</strong> layer plays an abstract role in the plot composite making for some key application notes that the user will need to be aware of. More on this subject can be explored in <a href="https://ggplot2-book.org/coord.html">Chapter 15 Coordinate systems</a> of <em>ggplot2: Elegant Graphics for Data Analysis</em>.</p>
<p>Previously, we mentioned that axis limits can be applied in <strong>Scales</strong>, but by doing so we unintetionally skew the results. Instead, it is better to “zoom” into a plot using the <strong>Coordinates</strong> layer. In a similar vein, if we want to swap the axes our <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> variables get plotted to, we want to use <code>coord_flip()</code> instead of changing <code>aes(x = x_var, y = y_var)</code> to <code>aes(x = y_var, y = x_var)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># By default plots are generated on non-transformed Cartesian coordinates.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">%in%</span> include_seeasons, Level <span class="sc">%in%</span> ages_ordered) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel, <span class="at">color =</span> Season) ) <span class="sc">+</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"RSV Infection Trends Since 2022"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Weeks Since July"</span>, </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Positive RSV Tests</span><span class="sc">\n</span><span class="st">(scaled and kernel smoothed)"</span>) <span class="sc">+</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>, <span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The following line not required for us to include.</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Code Like a Pro">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Code Like a Pro
</div>
</div>
<div class="callout-body-container callout-body">
<p>As with any grammar, there are different ways we can make a statement. Say we have a variable that plots with a curve, and you know that you can linearize it using a base 10 <span class="math inline">\(\log\)</span>. We now have three approaches to graphically representing its linearized transformation. This example is from the <code>coord_trans()</code> documentation, <a href="https://ggplot2.tidyverse.org/reference/coord_trans.html">Transformed Cartesian coordinate system</a>.</p>
<ul>
<li>Transform before plotting or in <code>aes()</code> with <code>log10()</code>. <strong>NOTE:</strong> only do simple transformations in <code>aes()</code>, like a <span class="math inline">\(\log_{10}\)</span> transformation, and leave more complicated operations to more robust methods.</li>
<li><strong>Scales</strong>: <code>scale_*_log10()</code> or <code>scale_*_continuous(trans = "log10")</code></li>
<li><strong>Coordinates</strong>: <code>coord_trans(* = "log10")</code></li>
</ul>
<p><strong>Discussion:</strong> If we apply each option individually, do they all plot the same way? If not, what do you think is happening and how would you fix the code?</p>
</div>
</div>
</section>
<section id="the-theme-layer" class="level3">
<h3 class="anchored" data-anchor-id="the-theme-layer">The <strong>Theme</strong> Layer</h3>
<p>The <strong>Theme</strong> layer gives the users control over non-data aspects of the plot: i.e.&nbsp;styling the fonts, axes ticks, panel strips, backgrounds, location (or the exclusion) of the legend, etc. It’s used to format the plot to make it visually appealing or match intended design schemes. Unlike every other layer described, <strong>Theme</strong> will not change how values are transformed, their perceptual properties, or how geometries get rendered.</p>
<p>How the user intends to use <strong>Themes</strong> will depend on where in the data procesing cycle they are performing visualization, and how they want their polished plots to look. It is therefore not likely to be helpful if I get granular about the different function arguments in <strong>Themes</strong>. Instead, I encourage students to explore the layer reference page, where they can peruse details for all the possible function arguments at their leisure: <a href="https://ggplot2.tidyverse.org/reference/theme.html#ref-usage">Modify components of a theme</a>.</p>
<p><code>ggplot2</code> comes with numerous theme that get installed with the package: <a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">Complete themes</a>. There are also numerous community developed themes that you can load, some of which have been curated by R Charts: <a href="https://r-charts.com/ggplot2/themes/">Themes in ggplot2</a>.</p>
<p>Each time you make a plot, the default is <code>theme_gray()</code>. As before, you do not need to explicitely write this out if you do not intend to change the default settings. In our example, we want use another, more visually appealing theme that better displays our results. We will use another <code>ggplot</code> provided theme: <code>theme_linedraw()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using one of ggplot2's provided theme presets.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">%in%</span> include_seeasons, Level <span class="sc">%in%</span> ages_ordered) <span class="sc">|&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel, <span class="at">color =</span> Season) ) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"RSV Infection Trends Since 2022"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Weeks Since July"</span>, </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Positive RSV Tests</span><span class="sc">\n</span><span class="st">(scaled and kernel smoothed)"</span>) <span class="sc">+</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>, <span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span><span class="fu">factor</span>(Level, <span class="at">levels =</span> ages_ordered)) <span class="sc">+</span> </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the Themes layer at the end of our plot object expression.</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_linedraw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Worked-Through-Example_files/figure-html/layers_theme-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Code Like a Pro">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Code Like a Pro
</div>
</div>
<div class="callout-body-container callout-body">
<p>Say you regularly generate plots that you want to apply the same custom <strong>Theme</strong> settings to, such as producing visualizations for a group that has specific branding or plots for a cohesive publication. There are two possible solutions you can take that will obviate the need to rewrite the same theme settings in each plot object.</p>
<ul>
<li><code>theme_set()</code> allows you to set a new theme globally, overriding the default theme settings for the environment: <a href="https://ggplot2.tidyverse.org/reference/theme_get.html">Get, set, and modify the active theme</a>.</li>
<li>Creating your own custom theme function by modify an existing <code>theme_*()</code> or writing one from scratch: <a href="https://rpubs.com/mclaire19/ggplot2-custom-themes">Learning to create custom themes in ggplot</a> by Maddie Pickens and <a href="https://ggplot2-book.org/extensions.html#new-themes">Chapter 20.1 New Themes</a> of <em>ggplot2: Elegant Graphics for Data Analysis</em>.</li>
</ul>
</div>
</div>
</section>
<section id="overlaying-layers" class="level3">
<h3 class="anchored" data-anchor-id="overlaying-layers">Overlaying Layers</h3>
<p>Now that we have become acclimated to each layer that constitutes one cohesive graph, we are ready to discuss how to effectively build more complex graphs by overlaying additional layers. Earlier I hinted that the expressions for each layer stands alone as it’s own object in the programming environment. When a graph is rendered by <code>ggplot2</code> it’s going to compress these layers one on top of another sequentially.</p>
<p>This is all well and good if the plots we are generating contain the same <strong>Data</strong> and <strong>Mapping</strong> settings, but what if they do not? What if we want to plot a new <strong>Geometry</strong> or <strong>Statistic</strong> layer that doesn’t use the same settings used by other layers? Every time you add a new layer, you have the opportunity to override the inherited settings that were given in the leading plot object, <code>ggplot()</code>.</p>
<p>For example, consider the following code. What happens if we change aspects of the <strong>Data</strong> and <strong>Mapping</strong> used by <code>geom_line()</code>?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel)) <span class="sc">+</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<table class="caption-top table">
<caption>Overriding <code>ggplot()</code>table from <a href="https://ggplot2-book.org/layers.html#sec-plots-and-layers">13.4 Aesthetic mappings</a> in <em>ggplot2: Elegant Graphics for Data Analysis</em>.</caption>
<thead>
<tr class="header">
<th>Operation</th>
<th style="text-align: left;">Layer aesthetics</th>
<th style="text-align: left;">Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Add</td>
<td style="text-align: left;"><code>aes(colour = Season)</code></td>
<td style="text-align: left;"><code>aes(x = MMWRweek, y = Kernel, colour = Season)</code></td>
</tr>
<tr class="even">
<td>Override</td>
<td style="text-align: left;"><code>aes(y = Level)</code></td>
<td style="text-align: left;"><code>aes(x = MMWRweek, y = Level)</code></td>
</tr>
<tr class="odd">
<td>Remove</td>
<td style="text-align: left;"><code>aes(y = NULL)</code></td>
<td style="text-align: left;"><code>aes(x = MMWRweek)</code></td>
</tr>
</tbody>
</table>
<p>It is therefore best practice to assign the <strong>Data</strong> or <strong>Mapping</strong> in the leading <code>ggplot()</code> plot object when you want those settings carried forward to all subsequent layers. When you need to specify new settings for select <strong>Geometric</strong> or <strong>Statistic</strong> layers, then you can specify those mappings in that layer, overriding any previous designation. You can find more information about plot object layering in <code>ggplot</code> in <a href="https://ggplot2-book.org/layers.html#sec-plots-and-layers">Chapter 13 Build a plot layer by layer</a> in <em>ggplot2: Elegant Graphics for Data Analysis</em>.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Code Like a Pro">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Code Like a Pro
</div>
</div>
<div class="callout-body-container callout-body">
<p>The ability to treat each layer as it’s own object in the coding environment allows for flexible and adaptive programming. For example, you can predefined the settings to generating a smoothed line that you apply to different <code>ggplot()</code> objects, leaning on inherited <strong>Data</strong> and/or aesthetics <strong>Mappings</strong> given in each.</p>
<p>You can find more information about plot object layering in <code>ggplot</code> in <a href="https://ggplot2-book.org/programming.html">Chapter 18 Programming with ggplot2</a> in <em>ggplot2: Elegant Graphics for Data Analysis</em>.</p>
</div>
</div>
<p>To exhibit this in our running example, let’s add our pièce de résistance, the cherry on top, a leading point highlighting the most recently recorded surveillance week. In order to isolate this exact point, we need to prepare a different subset from the same dataset. We do this by filtering for the same distinguishing variables (Region, Season, and Characteristic Level), followed by filtering to the current infections season, and then finally the most recent week recorded.</p>
<p>This point is added to our graph as a fresh layer that is printed on the plot object generated up to the <code>geom_line()</code> expression. In the function settings, we override the inherited <strong>Data</strong> object and leave the <strong>Mappings</strong> blank, allowing the aesthetics settings to be inherited from the <code>ggplot()</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset the dataset to isolate the leading data point we wish to plot.</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>leading_point <span class="ot">=</span> df <span class="sc">|&gt;</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">%in%</span> include_seeasons, Level <span class="sc">%in%</span> ages_ordered) <span class="sc">|&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MMWRyear <span class="sc">==</span> <span class="fu">max</span>(MMWRyear)) <span class="sc">|&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MMWRweek <span class="sc">==</span> <span class="fu">max</span>(MMWRweek))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a new Geometry layer, geom_point(), using a new dataset.</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Region <span class="sc">==</span> <span class="st">"Connecticut"</span>, Season <span class="sc">%in%</span> include_seeasons, Level <span class="sc">%in%</span> ages_ordered) <span class="sc">|&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> MMWRweek, <span class="at">y =</span> Kernel, <span class="at">color =</span> Season) ) <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span>  </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show the leading point as a red dot using the leading_point subset.</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> leading_point, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"RSV Infection Trends Since 2022"</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Weeks Since July"</span>, </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Positive RSV Tests</span><span class="sc">\n</span><span class="st">(scaled and kernel smoothed)"</span>) <span class="sc">+</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>, <span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span><span class="fu">factor</span>(Level, <span class="at">levels =</span> ages_ordered)) <span class="sc">+</span> </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_linedraw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Worked-Through-Example_files/figure-html/layers_basic%20plot-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Look at us, we are such <code>ggplot</code> experts now! High five! Oh wait a second, this is aesynchronous material… give yourself a high five for me <span class="emoji" data-emoji="+1">👍</span>.</p>
</section>
</section>
<section id="advanced-uses-of-ggplot2" class="level2">
<h2 class="anchored" data-anchor-id="advanced-uses-of-ggplot2">Advanced Uses of <code>ggplot2()</code></h2>
<p>In this section we will cover two advanced uses of <code>ggplot2</code> commonly used in public health: projecting data into a map and making the values intractable.</p>
<section id="introduction-to-map-projections-with-ggoplot" class="level3">
<h3 class="anchored" data-anchor-id="introduction-to-map-projections-with-ggoplot">Introduction to Map Projections with <code>ggoplot</code></h3>
</section>
<section id="introduction-to-interactive-plotting-with-plotly" class="level3">
<h3 class="anchored" data-anchor-id="introduction-to-interactive-plotting-with-plotly">Introduction to Interactive Plotting with <code>plotly</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#renderPlotly({</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#map_data &lt;- epic_ed_combo %&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#      filter(date == input$selected_date &amp; Level == '&lt;1 Years') %&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#      mutate(state = state.abb[match(geography, state.name)] ,</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>             <span class="co">#Note, if &gt;20%, cap at 20 for plotting!</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">#           pct_RSV_ED_epic= if_else(pct_RSV_ED_epic&gt;20,20, pct_RSV_ED_epic)  ) %&gt;%</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(!is.na(state)) %&gt;%</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   as.data.frame()</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># max.val &lt;- max(epic_ed_combo$pct_RSV_ED_epic, na.rm=T)</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">#pal1 &lt;- viridis_pal()(4)</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">#date.print &lt;- input$selected_date</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">#p1 &lt;- usmap::plot_usmap(regions = "state", data = map_data, values = "pct_RSV_ED_epic") +</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">#scale_fill_gradientn(</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#colors = pal1,</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#values = scales::rescale(c(0, 5, 10, 15, 20)),</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#limits = c(0, 20),</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#na.value = "#440154FF"</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#) +</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#ggtitle(paste("RSV ED Visit Percentage &lt;1 year olds on", date.print))</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co">#ggplotly(p1)</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co">#})</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="challenge-questions" class="level2">
<h2 class="anchored" data-anchor-id="challenge-questions">Challenge Questions</h2>
<ol type="1">
<li><p>In the worked through example we leverage two of the three distinguishing variables: Season and Characteristic Level. In this questions, we want to focus on the third one, Region. Using the final line-graph code from the worked through example, add a row-wise facet to compare two states or HHS regions.</p></li>
<li><p>In the polished version of the line plot we layered an additional point on the graph that highlighted the most currently represented date in the active infection season. To get this data, we externally filtered down the dataset to give that point, repeating some of the filtering we are already doing before the plot gets generated.</p>
<ol type="a">
<li>Can you modify this approach so that we no longer require the external dataset, thus simplifying our code?</li>
<li>Now try using <code>stat_summary(filtered_data, geom = "point", fun = "max", color = "red")</code> instead of <code>geom_point()</code>. If you only filter to MMWRyear, do you get the same result, and if not why?</li>
</ol></li>
<li><p>We want to see how many counties called “Adams” are represented in the data set.</p>
<ol type="a">
<li>Subset the data set by string matches in <code>County</code> and find how many rows you see. Remember that each county is expected to have 39 different dates reported.</li>
<li>Table your subset results by <code>County</code> and <code>Province_State</code>. Does this change the answer you got from part a?</li>
</ol></li>
</ol>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
<p>This workshop was generated using R (v 4.4.4) in the RStudio IDE (v 2024.12.1+563). <code>renv</code> was used to store all the relevant packages and package versions with the workshop codespace. All of the workshop materials can be accessed on the ysph-dsde GitHub: <a href="https://github.com/ysph-dsde/Data-Visualization-with-ggplot2/">Data Visualization with ggplo2</a>.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>